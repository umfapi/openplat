## 报文格式说明

**变更历史** 

| **变更日期** | **操作人** | **变更方式** | **变更内容** |
| ------------ | ---------- | ------------ | ------------ |
| 2020-01-09   | 李塔       | 初稿         |              |

**简要描述** 

- 交易接口主要定义POS机具、品牌方平台、联动平台交互报文
- POS机具参数下载接口直连联动平台，其余POS交易通过品牌方平台请求联动平台
- 品牌方通过联动平台提供的解包接口获取POS报文类型及必要的报文内容
- 品牌方通过联动平台提供的封包接口返回错误信息及描述
- 联动平台提供交易接口处理品牌方添加了附加信息的POS交易报文，交易接口为广义交易接口，可提供签到、签退、消费等多种类型交易

**请求URL** 

- `IP:PORT`

**请求方式**

- TCP

**交互流程**

![联动解包时序图](https://raw.githubusercontent.com/umfapi/openplat/master/3、大POS交易/联动解包时序图.png)

```sequence

POS机具 -> 服务商: 交易请求
服务商 -> 联动解包:报文解包
联动解包 - 服务商:报文类型及必要内容
服务商 --> 联动封包:需要返回POS机具错误信息(报文封包)
联动封包 -- 服务商:返回POS机具报文
服务商 -- POS机具:返回错误信息
服务商 -> 联动交易:请求交易
联动交易 - 服务商:交易返回
服务商 - POS机具:返回交易结果
```



**报文格式**

| **参数名**           | **长度(字节)** | **说明**                          |
| -------------------- | ------------------------------ | --------------------------------- |
| 总长度域             | 2                              | 后续报文总长度，不包含该域2字节   |
| TPDU                 | 5                              | 固定值                            |
| 应用类别             | 2                              |                                   |
| 软件版本号           | 2                              |                                   |
| 处理要求             | 1                              |                                   |
| 终端状态             | 1                              |                                   |
| 接入方式             | 1                              | 1:TCP 2:HTTPS 3:服务商            |
| 加密方式             | 1                              |                                   |
| 保留使用             | 2                              |                                   |
| 终端号               | 12                             | 明文String                        |
| 加密前8583报文体大小 | 2                              |                                   |
| 报文处理方式         | 1                              | 服务商强制修改                    |
| 是否包含附加报文域   | 1                              | 0:不包含 1:包含                   |
| 附加报文域长度       | 2                              | 服务商强制修改   (不含校验值长度) |
| 预留域               | 14                             |                                   |
| 加密后8583报文体     | 不定长                         |                                   |
| 附加报文域           | 不定长                         | TLV格式                           |
| 附加报文域校验值     | 2                              | CRC-16                            |

**报文处理方式String** 

- 0-POS上送原始值
- 1-报文解包
- 2-报文组包
- 3-交易处理

**请求报文处理** 

- 请求报文一律在原POS请求报文的基础上修改
- 服务商附加报文域、附加报文域校验值为服务商添加，其余域均为POS上送域
- 服务商需要强制修改原报文 总长度域为真实总长度包含附加域及校验值
- 服务商需要强制修改原报文 接入方式为3
- 服务商需要强制修改原报文 报文处理方式
- 服务商需要强制修改原报文 是否包含附加报文域
- 服务商需要强制修改原报文 附加报文域长度
- 服务商需要添加附加报文域及附加报文域校验值

**请求报文说明** 

- 报文解包 POS请求报文(变更报文头)+TLV附加域
- 报文组包 POS请求报文(变更报文头)+TLV附加域
- 交易处理 POS请求报文(变更报文头)+TLV附加域

**返回报文处理** 

- 判断不存在附加报文域的直接返回POS
- 判断存在报文附加域的删除附加域并修改报文总长度域后返回POS

**返回报文说明** 

- 报文解包 请求报文+TLV附加域
- 报文组包 返回报文+TLV附加域
- 交易处理 返回报文+TLV附加域

**TLV****定义** 

| **参数名** | **必选** | **类型** | **说明**                          |
| ---------- | ------------ | -------- | --------------------------------- |
| BF01       |              | string   | 返回码                            |
| BF02       |              | string   | 8583报文类型                      |
| BF03       |              | string   | 商户编码                          |
| BF04       |              | string   | 终端编码                          |
| BF05       |              | string   | 服务商自定义返回码 必须以D开头2位 |
| BF06       |              | string   | 返回描述                          |
| BF07       |              | string   | 品牌编号                          |
| BF08       |              | string   | 品牌交易流水(32位定长)不重复      |
| BF09       |              | string   | 红包金额                          |
| BF0A       |              | string   | 是否结算   0-否 1-是              |
| BF0B       |              | string   | 品牌费率编号                      |
| BF0C       |              | string   | 服务编号                          |
| BF0D       |              | string   | 交易卡号                          |
| BF0E       |              | string   | 交易金额                          |

**返回码** 

| **返回码** | **说明**     |
| -------------- | ------------ |
| 00             | 交易成功     |
| K1             | 8583解包失败 |
| K2             | MAC校验失败  |
| K3             | 请求报文非法 |

**备注** 

- 报文涉及中文编码均使用GBK
- 更多